# Render Deployment Guide with render.yaml

This guide explains how to deploy Jits Journal backend to Render using the `render.yaml` configuration file.

## Why render.yaml?

Using `render.yaml` provides several benefits:
- **Infrastructure as Code**: Your deployment configuration is version-controlled
- **Easy Updates**: Simply push changes and Render automatically detects and updates your service
- **Consistency**: Same configuration across deployments
- **Auto-deployment**: Render automatically deploys when you push to your main branch

## Prerequisites

1. A Render account (sign up at https://render.com)
2. Your repository connected to Render
3. All required environment variables ready

## Setup Instructions

### Step 1: Connect Your Repository to Render

1. Go to https://dashboard.render.com
2. Click "New +" â†’ "Blueprint"
3. Connect your GitHub/GitLab repository
4. Render will automatically detect the `render.yaml` file

### Step 2: Configure Environment Variables

You need to set the following environment variables in the Render dashboard:

#### Database
- `DATABASE_URL` - Your Neon PostgreSQL connection string
  - Format: `postgresql://user:password@host/database?sslmode=require`

#### Supabase (Authentication & Storage)
- `VITE_SUPABASE_URL` - Your Supabase project URL
- `SUPABASE_SERVICE_ROLE_KEY` - Supabase service role key (secret)
- `SUPABASE_JWT_SECRET` - Supabase JWT secret for fast token verification

#### Email (Gmail SMTP)
- `GMAIL_USER` - Your Gmail address (e.g., bjjjitsjournal@gmail.com)
- `GMAIL_APP_PASSWORD` - Gmail app password (not your regular password)

#### Cloudflare R2 Storage
- `R2_ENDPOINT` - Your Cloudflare R2 endpoint
- `R2_ACCESS_KEY_ID` - R2 access key ID
- `R2_SECRET_ACCESS_KEY` - R2 secret access key
- `R2_BUCKET_NAME` - Set to `jitsjournal-videos` (or your bucket name)

#### Stripe Payments
- `STRIPE_SECRET_KEY` - Stripe secret key
- `STRIPE_ENTHUSIAST_PRICE_ID` - Stripe price ID for Enthusiast tier
- `VITE_STRIPE_ENTHUSIAST_PRICE_ID` - Same as above (for frontend)
- `STRIPE_GYM_PRO_PRICE_ID` - Stripe price ID for Gym Pro tier
- `VITE_STRIPE_GYM_PRO_PRICE_ID` - Same as above (for frontend)
- `STRIPE_WEBHOOK_SECRET` - Stripe webhook signing secret

#### OpenAI
- `OPENAI_API_KEY` - OpenAI API key for AI features

#### App Configuration
- `VITE_APP_URL` - Your production frontend URL (update in render.yaml or dashboard)

**Note:** The `JWT_SECRET` will be auto-generated by Render. `PORT` is automatically set by Render.

### Step 3: Deploy

1. After connecting your repository and setting environment variables:
   - Render will automatically build and deploy your service
   - Future pushes to the `main` branch will trigger automatic deployments

2. Monitor the deployment:
   - Go to your service dashboard on Render
   - Click on "Logs" to see build and runtime logs
   - Check "Events" for deployment history

### Step 4: Verify Deployment

1. Once deployed, visit your service URL (e.g., `https://jitsjournal-backend.onrender.com`)
2. Test the health endpoint: `https://your-service.onrender.com/api/health`
3. Check that your frontend can connect to the backend

## Updating render.yaml

If you need to modify the configuration:

1. Edit `render.yaml` in your repository
2. Commit and push the changes:
   ```bash
   git add render.yaml
   git commit -m "Update Render configuration"
   git push origin main
   ```
3. Render will automatically detect the changes and update your service

## Important Notes

### Health Check
The render.yaml is configured to use `/api/health` as the health check endpoint. Make sure this endpoint exists in your backend and returns a 200 status code.

### Environment Variables marked with `sync: false`
These variables need to be manually set in the Render dashboard. They won't be automatically synced from the YAML file for security reasons.

### Auto-generated Secrets
Variables with `generateValue: true` (like JWT_SECRET) will be automatically generated by Render on first deployment.

### Plan Selection
The configuration uses the "Starter" plan. You can upgrade this in the Render dashboard if needed.

### Region
Currently set to "oregon". You can change this in render.yaml to other regions if needed.

## Common Issues

### Build Fails
- Check the build logs in Render dashboard
- Ensure all dependencies are listed in package.json
- Verify Node.js version compatibility

### Service Won't Start
- Check runtime logs for errors
- Verify all required environment variables are set
- Ensure DATABASE_URL is correct and database is accessible

### Health Check Failing
- Verify the `/api/health` endpoint exists and returns 200
- Check that the service is listening on the PORT environment variable
- Review application logs for startup errors

## Migration from Manual Setup

If you previously set up your service manually on Render:

1. Note all your current environment variables
2. Delete the old service (or keep it as backup)
3. Follow the setup instructions above to create a new service using render.yaml
4. Set all environment variables in the new service
5. Update your frontend to point to the new backend URL

## Next Steps

After successful deployment:
1. Update your frontend environment variables to use the new backend URL
2. Test all features (authentication, file uploads, payments)
3. Monitor logs for any errors
4. Set up custom domain if needed (in Render dashboard)
