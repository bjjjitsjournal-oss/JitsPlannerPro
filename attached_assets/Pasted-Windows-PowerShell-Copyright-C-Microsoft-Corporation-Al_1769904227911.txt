Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows

PS C:\Users\joe> cd C:\Users\joe\Documents\JitsPlannerPro
PS C:\Users\joe\Documents\JitsPlannerPro>
PS C:\Users\joe\Documents\JitsPlannerPro> # Read all lines
PS C:\Users\joe\Documents\JitsPlannerPro> $lines = Get-Content "server/routes.ts"
PS C:\Users\joe\Documents\JitsPlannerPro> $newLines = @()
PS C:\Users\joe\Documents\JitsPlannerPro>
PS C:\Users\joe\Documents\JitsPlannerPro> for ($i = 0; $i -lt $lines.Count; $i++) {
>>     $line = $lines[$i]
>>
>>     # Line 1888 (0-indexed 1887) - after "const { supabaseId } = req.params;"
>>     if ($i -eq 1887) {
>>         $newLines += $line
>>         $newLines += '      const email = req.query.email as string | undefined;'
>>     }
>>     # Line 1889 - change the console.log to include email
>>     elseif ($i -eq 1888 -and $line -match "console.log\('Looking up user by Supabase ID:'") {
>>         $newLines += "      console.log('Looking up user by Supabase ID:', supabaseId, 'email:', email);"
>>     }
>>     # Line 1891 - change "const result" to "let result"
>>     elseif ($i -eq 1890 -and $line -match "const result = await pool.query") {
>>         $newLines += "      let result = await pool.query("
>>     }
>>     # Line 1896 (after the closing paren of first query) - add the email lookup block
>>     elseif ($i -eq 1895 -and $line -match "\);") {
>>         $newLines += $line
>>         $newLines += ''
>>         $newLines += '      // If not found by supabase_uid but email provided, try to find and link by email'
>>         $newLines += '      if (result.rows.length === 0 && email) {'
>>         $newLines += "        console.log('User not found by Supabase ID, trying email lookup:', email);"
>>         $newLines += '        const emailResult = await pool.query('
>>         $newLines += "          'SELECT * FROM users WHERE email = `$1',"
>>         $newLines += '          [email]'
>>         $newLines += '        );'
>>         $newLines += ''
>>         $newLines += '        if (emailResult.rows.length > 0) {'
>>         $newLines += '          const existingUser = emailResult.rows[0];'
>>         $newLines += "          console.log('Found user by email, linking Supabase ID:', existingUser.id);"
>>         $newLines += ''
>>         $newLines += '          await pool.query('
>>         $newLines += "            'UPDATE users SET supabase_uid = `$1 WHERE id = `$2',"
>>         $newLines += '            [supabaseId, existingUser.id]'
>>         $newLines += '          );'
>>         $newLines += "          console.log('Linked Supabase ID to existing user:', existingUser.email);"
>>         $newLines += ''
>>         $newLines += '          result = await pool.query('
>>         $newLines += "            'SELECT * FROM users WHERE id = `$1',"
>>         $newLines += '            [existingUser.id]'
>>         $newLines += '          );'
>>         $newLines += '        }'
>>         $newLines += '      }'
>>     }
>>     else {
>>         $newLines += $line
>>     }
>> }
PS C:\Users\joe\Documents\JitsPlannerPro>
PS C:\Users\joe\Documents\JitsPlannerPro> $newLines | Set-Content "server/routes.ts"
PS C:\Users\joe\Documents\JitsPlannerPro> Write-Host "Updated routes.ts"
Updated routes.ts
PS C:\Users\joe\Documents\JitsPlannerPro>
PS C:\Users\joe\Documents\JitsPlannerPro> # Verify the change
PS C:\Users\joe\Documents\JitsPlannerPro> Get-Content "server/routes.ts" | Select-Object -Index (1885..1930)
  app.get("/api/user/by-supabase-id/:supabaseId", async (req, res) => {
    try {
      const { supabaseId } = req.params;
      const email = req.query.email as string | undefined;
      console.log('Looking up user by Supabase ID:', supabaseId, 'email:', email);

      let result = await pool.query(
        'SELECT * FROM users WHERE supabase_uid = $1',
        [supabaseId]
      );

      if (result.rows.length > 0) {
        console.log('Found user:', result.rows[0].id);
        let user = result.rows[0];

        // Auto-assign admin role for specific emails
        const adminEmails = ['bjjjitsjournal@gmail.com', 'admin@apexbjj.com.au'];
        const isAdmin = adminEmails.includes(user.email);
        if (isAdmin && user.role !== 'admin') {
          const updatedUser = await storage.updateUser(user.id, {
            role: 'admin'
          });
          console.log(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Auto-assigned admin role to ${user.email}`);

          // Return updated user
          if (updatedUser) {
            user = updatedUser;
          }
        }

        res.json(user);
      } else {
        console.log('User not found');
        res.status(404).json({ message: 'User not found' });
      }
    } catch (error: any) {
      console.error('Error fetching user by Supabase ID:', error);
      res.status(500).json({ message: 'Error fetching user: ' + error.message });
    }
  });

  // Get user statistics
  app.get("/api/user-stats", authenticateToken, async (req, res) => {
    try {
      const userId = (req as any).user.userId;
